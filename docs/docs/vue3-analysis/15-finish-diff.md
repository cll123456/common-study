

# å¼•è¨€
<<å¾€æœŸå›é¡¾>>

1.  [vue3æºç åˆ†æâ€”â€”å®ç°ç»„ä»¶é€šä¿¡provide,inject](https://juejin.cn/post/7111682377507667999 "https://juejin.cn/post/7111682377507667999")
1.  [vue3æºç åˆ†æâ€”â€”å®ç°createRendererï¼Œå¢åŠ runtime-test](https://juejin.cn/post/7112349410528329758 "https://juejin.cn/post/7112349410528329758")
2. [ vue3æºç åˆ†æâ€”â€”å®ç°elementå±æ€§æ›´æ–°ï¼Œchildæ›´æ–°](https://juejin.cn/post/7114203851770560525)

æœ¬æœŸæ¥å®ç°ï¼Œä¸Šä¸€æœŸä¸­è¿˜å·®äº†childrenä¸childrençš„å¯¹æ¯”ğŸ˜‰ğŸ˜‰ğŸ˜‰ **vue3æ›´æ–°æµç¨‹ä¸­çš„childrenä¸childrençš„å¯¹æ¯”ï¼Œä¹Ÿå°±æ˜¯diffç®—æ³•**ï¼Œæ‰€æœ‰çš„[æºç è¯·æŸ¥çœ‹](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcll123456%2Fcommon-study%2Ftree%2Fmaster%2Fvue3-analysis%2F14-finish-comp-update "https://github.com/cll123456/common-study/tree/master/vue3-analysis/14-finish-comp-update")




# æ­£æ–‡
> åœ¨childrenäºchildrençš„å¯¹æ¯”ä¸­ï¼Œvue3é‡‡ç”¨çš„æ˜¯**åŒç«¯å¯¹æ¯”**çš„æ–¹å¼ï¼Œä½¿ç”¨3ä¸ªæŒ‡é’ˆæ¥è¿›è¡Œç§»åŠ¨å¯¹æ¯”ï¼Œé‚£è‚¯å®šå°±ä¼šæœ‰è®¸å¤šçš„æƒ…å†µï¼Œä¸”å¬æˆ‘æ…¢æ…¢é“æ¥ğŸ‘ğŸ‘ğŸ‘ï¼

## å…ˆçœ‹ä¸ªç»“æœ

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/513b9ea68b1e44d78fef81642c0ea82e~tplv-k3u1fbpfcp-watermark.image?)
> é€šè¿‡ä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯åˆ†äº†7ç§æƒ…å†µæ¥çš„ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« ï¼Œä¸é‡‡ç”¨ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å»githubä¸Šé¢æŸ¥çœ‹ï¼Œè¿™é‡Œä¸»è¦ä½¿ç”¨å›¾æ–‡åŠ ä¸Šä»£ç ï¼Œå¸®åŠ©å¤§å®¶æ›´å¿«çš„ç†è§£vue3ä¸­çš„diffç®—æ³•


# é”å®šå¯¹æ¯”çš„èŒƒå›´
æ—¢ç„¶é‡‡ç”¨çš„æ˜¯åŒç«¯å¯¹æ¯”ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯éœ€è¦3ä¸ªæŒ‡é’ˆçš„ï¼Œè¯·çœ‹ä¸‹å›¾ï¼š



![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cf6d1580df5d4552b5ddf94239354a34~tplv-k3u1fbpfcp-watermark.image?)
æ€»å…±æœ‰3ä¸ªæŒ‡é’ˆ
- i ä»£è¡¨çš„æ˜¯èµ·å§‹æŒ‡é’ˆé»˜è®¤æ˜¯  0
- e1 ä»£è¡¨çš„æ˜¯old childrençš„æœ«å°¾æŒ‡é’ˆï¼Œ é»˜è®¤æ˜¯ oldChildren.length -1
- e2 ä»£è¡¨çš„æ˜¯new childrençš„æœ«å°¾æŒ‡é’ˆï¼Œ é»˜è®¤æ˜¯ newChildren.length -1

æ—¢ç„¶æœ‰äº†æŒ‡é’ˆï¼Œé‚£æ˜¯å¦éœ€è¦é”å®šèŒƒå›´å‘¢ï¼æŒ‡é’ˆåšå¯¹åº”çš„ç§»åŠ¨ã€‚ç§»åŠ¨çš„æ–¹å¼å¦‚ä¸‹ï¼š
- å¦‚æœoldChildrenå’ŒnewChildrenå·¦è¾¹çš„èŠ‚ç‚¹éƒ½ä¸€æ ·ï¼Œé‚£ä¹ˆå°±éœ€è¦iå¾€å³è¾¹ç§»åŠ¨ï¼Œç›´åˆ°ä¸åŒä½ç½®åœæ­¢.
- å¦‚æœoldChildrenå’ŒnewChildrenå³è¾¹çš„èŠ‚ç‚¹éƒ½ä¸€æ ·ï¼Œé‚£ä¹ˆå¯¹åº”çš„e1å’Œe2å¾€å·¦è¾¹ç§»åŠ¨ï¼ŒåŒæ ·ä¹Ÿæ˜¯åˆ°ä¸åŒä½ç½®åœæ­¢ã€‚
æ ¹æ®ä¸Šé¢çš„éœ€æ±‚ï¼Œæˆ‘ç›¸ä¿¡éƒ½èƒ½å¾—å‡ºä¸€ä¸ªæ¡ä»¶å¹¶ä¸”å†™å‡ºä»¥ä¸‹ä»£ç 


```ts
export function patchKeyedChildren(oldChildren, newChildren){
    let i = 0;
    let e1 = oldChildren.length - 1;
    let e2 = newChildren.length - 1;
    
    // å½“ i <= e1 && i<= e2çš„æ—¶å€™ï¼Œéœ€è¦å·¦è¾¹ç§»åŠ¨
    while(i <= e1 && i <= e2){
      if(oldChildren[i] ç­‰äº newChildren[i]){
        i++
      }else{
        break;
      }
    }
    
    // åŒç†ï¼Œå³è¾¹çš„æŒ‡é’ˆå¾€å·¦è¾¹ç§»åŠ¨ä¹Ÿæ˜¯è¿™æ ·
      while(i <= e1 && i <= e2){
      if(oldChildren[e1] ç­‰äº newChildren[e2]){
        el--;
        e2--;
      }else{
        break;
      }
    }
}
```
> ä¸Šé¢çš„ä»£ç æ˜¯**ä¼ªä»£ç **ï¼Œä¸»è¦æ˜¯ç”¨äºè¯´æ˜æƒ…å†µï¼ŒåŒç«¯å¯¹æ¯”ï¼Œæ‹¿åˆ°ä¸ç›¸åŒçš„éƒ¨åˆ†ï¼Œæ¥ä¸‹æ¥æ ¹æ®ä¸ç›¸åŒçš„éƒ¨åˆ†æ¥è¿›è¡Œåˆ†æƒ…å†µè®¨è®º

# åˆ†æƒ…å†µè®¨è®º
æ€»å…±æœ‰7ä¸­æƒ…å†µï¼Œåˆ†åˆ«æ˜¯ï¼š

1. è€çš„æ¯”æ–°çš„**å·¦è¾¹é•¿**ï¼Œåœ¨æ–°çš„å·¦è¾¹åˆ›åˆ é™¤çš„èŠ‚ç‚¹
2. è€çš„æ¯”æ–°çš„**å³è¾¹é•¿**ï¼Œåœ¨æ–°çš„å³è¾¹åˆ›åˆ é™¤çš„èŠ‚ç‚¹
3. è€çš„æ¯”æ–°å¤§**å·¦è¾¹çŸ­**,åœ¨æ–°çš„å·¦è¾¹åˆ›å»ºæ–°çš„èŠ‚ç‚¹
4. è€çš„æ¯”æ–°çš„**å³è¾¹çŸ­**ï¼Œåœ¨æ–°çš„å³è¾¹åˆ›å»ºæ–°çš„èŠ‚ç‚¹
5. è€çš„æ¯”æ–°çš„**ä¸­é—´èŠ‚ç‚¹å¤š**,åˆ é™¤å¤šä½™çš„èŠ‚ç‚¹
6. è€çš„æ–°çš„**ä¸­é—´èŠ‚ç‚¹ä¸€æ ·å¤šï¼Œä½ç½®å‘ç”Ÿå˜åŒ–**ï¼Œéœ€è¦ç§»åŠ¨ä½ç½®
7. è€çš„æ–°çš„**ä¸­é—´èŠ‚ç‚¹å°‘**ï¼Œåˆ›å»ºæ–°çš„èŠ‚ç‚¹

## è€çš„å·¦å³è¾¹é•¿
> è¿™é‡ŒåŒ…å«äº†è€çš„å·¦è¾¹é•¿å’Œå³è¾¹é•¿ï¼Œéƒ½æ˜¯éœ€è¦åˆ é™¤å¯¹åº”è¾¹ç•Œçš„èŠ‚ç‚¹

### è€èŠ‚ç‚¹å·¦è¾¹é•¿
ä¼šå‘ç°ï¼Œ**iä¸åŠ¨ï¼Œ e1å’Œ e2ä¸¤ä¸ªæŒ‡é’ˆå¾€å·¦è¾¹ç§»åŠ¨**
![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1ced2e5370b1457e8c3927b1649d7374~tplv-k3u1fbpfcp-watermark.image?)


æœ€ç»ˆ `i = 0, e1 = 1, e2 = -1`,æ‰€ä»¥å¯ä»¥å¾—å‡ºä¸€ä¸ªæ¡ä»¶æ˜¯ `i > e2 && i <= e1`

### è€èŠ‚ç‚¹å³è¾¹é•¿
å¯ä»¥å‘ç°ï¼Œ**e1,e2ä¸åŠ¨ï¼Œiå¾€å³è¾¹ç§»åŠ¨**
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c883253ca494a31afc144cc48743652~tplv-k3u1fbpfcp-watermark.image?)
æœ€ç»ˆ `i = 3, e1 = 3, e2 = 2`,æ‰€ä»¥å¯ä»¥å¾—å‡ºä¸€ä¸ªæ¡ä»¶æ˜¯ `i > e2 && i <= e1`

è€çš„æ¯”æ–°çš„ä¸¤è¾¹é•¿ï¼Œå°±æ˜¯è¯´åªè¦æ»¡è¶³ `i > e2 && i <= e1`è¿™ä¸ªæ¡ä»¶ï¼Œé‚£å°±éœ€è¦æ‰§è¡Œåˆ é™¤æ“ä½œ

```ts
export function patchKeyedChildren(oldChildren, newChildren){
// â€¦â€¦çœç•¥ä¸Šé¢çš„æŒ‡é’ˆç§»åŠ¨ä»£ç 
  if (i >= e2 && i <= e1) {
     // ä¸ºå•¥éœ€è¦whileå‘¢ï¼Œå› ä¸ºå¯èƒ½ä¸¤è¾¹å‡ºç°å¤šä¸ªå¤šä½™çš„èŠ‚ç‚¹ï¼Œéœ€è¦å¾ªç¯åˆ é™¤
      while (i <= e1) {
       // åˆ é™¤å½“å‰èŠ‚ç‚¹
        hostRemove(n1[i].el)
        i++
      }
    }
}
```

## è€çš„å·¦å³è¾¹çŸ­
> è¿™é‡ŒåŒ…å«äº†ï¼Œè€èŠ‚ç‚¹çš„å·¦è¾¹å’Œå³è¾¹æ¯”æ–°çš„èŠ‚ç‚¹æ˜¯æ›´çŸ­çš„ï¼Œéœ€è¦åˆ›å»ºæ–°çš„èŠ‚ç‚¹

### è€çš„æ¯”æ–°çš„å·¦è¾¹çŸ­
**iä¸åŠ¨ï¼Œe1ï¼Œe2å¾€å·¦è¾¹ç§»åŠ¨**


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/02ed58cb075f432ea1d1a1f8469a90d8~tplv-k3u1fbpfcp-watermark.image?)
æœ€ç»ˆ `i = 0, e1 = -1, e2 = 0`,æ‰€ä»¥å¯ä»¥å¾—å‡ºä¸€ä¸ªæ¡ä»¶æ˜¯ `i > e1 && i <= e2`

### è€çš„æ¯”æ–°çš„å³è¾¹çŸ­
**e1,e2ä¸åŠ¨ï¼Œiå¾€å³è¾¹ç§»åŠ¨**


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e5de7d792c504184ae3f848694042066~tplv-k3u1fbpfcp-watermark.image?)
æœ€ç»ˆ `i = 3, e1 = 2, e2 = 3`,æ‰€ä»¥å¯ä»¥å¾—å‡ºä¸€ä¸ªæ¡ä»¶æ˜¯ `i > e1 && i <= e2`

è€çš„æ¯”æ–°çš„ä¸¤è¾¹çŸ­ï¼Œå°±æ˜¯è¯´åªè¦æ»¡è¶³ `i > e1 && i <= e2`è¿™ä¸ªæ¡ä»¶ï¼Œé‚£å°±éœ€è¦æ‰§è¡Œæ–°å¢èŠ‚ç‚¹çš„æ“ä½œ


```ts
export function patchKeyedChildren(oldChildren, newChildren){
// â€¦â€¦çœç•¥ä¸Šé¢çš„ä»£ç 
else  if (i > e1 && i <= e2) {
      //     a b   i = 0 e1 = -1 e2 = 0
      // d c a b  éœ€è¦æ‰¾åˆ°açš„ä½ç½®
      const nextPos = e2 + 1;
      const anchor = nextPos < l2 ? n2[nextPos].el : null
     // åŒç†ï¼Œéœ€è¦å¾ªç¯å¢åŠ èŠ‚ç‚¹
      while (i <= e2) {
       // æ’å…¥èŠ‚ç‚¹
       patch(null, n2[i], container, parentComponent, anchor)
        i++
      }
    }
}
```
> çœ‹åˆ°è¿™é‡Œï¼Œæ­å–œä½ ğŸ‘ğŸ‘ğŸ‘ï¼Œvue3 diffçš„åŒç«¯å¯¹æ¯”å°±å·²ç»ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥é”å®šäº†ä¸€ä¸ªä¸­é—´èŒƒå›´ï¼Œæ¥åˆ¤æ–­ä¸­é—´èŒƒå›´çš„å†…å®¹ï¼Œåˆ é™¤ï¼Œç§»åŠ¨ä½ç½®ï¼Œæ–°å¢

## ä¸­é—´èŠ‚ç‚¹è€çš„æ¯”æ–°çš„å¤š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7dc3e6a253d64cfb9be11b25785af60b~tplv-k3u1fbpfcp-watermark.image?)

é€šè¿‡ä¸Šé¢ä»£ç çš„æ‰§è¡Œï¼Œæœ€ç»ˆ `i = 2, e1 =2ï¼Œ e2 = 2`ï¼Œä½†æ˜¯è¿™ä¸ªä¸å¯ä»¥ä½œä¸ºæ¡ä»¶å“¦ï¼æ€è·¯éœ€è¦è½¬ä¸ªå¼¯ğŸ¦®ğŸ¦®ğŸ¦®

é€šè¿‡**i å’Œ e1**å¯ä»¥é”å®šï¼Œè€èŠ‚ç‚¹ä¸­é—´éƒ¨åˆ†ï¼Œ**i å’Œ e2**å¯ä»¥é”å®šæ–°èŠ‚ç‚¹çš„èŒƒå›´;
éå†è€çš„èŠ‚ç‚¹,åˆ¤æ–­è€çš„èŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹ä¸­æ˜¯å¦å­˜åœ¨,å¯ä»¥ä½¿ç”¨åŒé‡forå¾ªç¯,ä½†æ˜¯æ¯”è¾ƒè´¹æ—¶é—´,å¯ä»¥æŠŠæ–°èŠ‚ç‚¹çš„å†…å®¹ç»™ç¼“å­˜èµ·æ¥,é‚£ä¹ˆå¯ä»¥é€šè¿‡ç©ºé—´æ¥æ¢å–æ—¶é—´


```js
export function patchKeyedChildren(oldChildren, newChildren){
// â€¦â€¦çœç•¥ä¸Šé¢çš„ä»£ç 
else{
    // ä¸­é—´å¯¹æ¯”
      const s1 = i;
      const s2 = i;
      // a b c d   i = 2 e1 = 2 e2 = 1
      // a b d
      // æ¡ä»¶  åˆ é™¤c

      // åˆ¤æ–­æ—§èŠ‚ç‚¹æ˜¯å¦åœ¨æ–°èŠ‚ç‚¹é‡Œé¢ï¼Œåœ¨çš„è¯ä¿ç•™ï¼Œä¸åœ¨åˆ™åˆ é™¤
      const newIndexToOldIndexMap = new Map()
        // æŠŠæ–°èŠ‚ç‚¹çš„keyè£…å…¥map
      for (let j = s2; j <= e2; j++) {
        newIndexToOldIndexMap.set(newChildren[j].key, j)
      }
      // ç„¶åéå†è€çš„èŠ‚ç‚¹,åˆ¤æ–­æ˜¯å¦åœ¨æ–°çš„èŠ‚ç‚¹é‡Œé¢
       for (let i = s1; i <= e1; i++) {
        let newIndex;
        if (n1[i].key !== null) {
          newIndex = newIndexToOldIndexMap.get(n1[i].key)
        } else {
          // key ä¸å­˜åœ¨ï¼Œéœ€è¦éå†æ–°èŠ‚ç‚¹ï¼Œçœ‹èƒ½ä¸èƒ½æ‰¾åˆ°è¿™ä¸ªèŠ‚ç‚¹
          for (let j = s2; j <= e2; j++) {
            if (isSameVNode(oldChildren[i], newChildren[j])) {
              newIndex = j
              break;
            }
          }
        }
        if (newIndex === undefined) {
          // åˆ é™¤èŠ‚ç‚¹
          hostRemove(n1[i].el)
       }
  }
}
```

> é€šè¿‡ä¸Šé¢å¯ä»¥å‘ç°,**å¦‚æœåœ¨ä¸­é—´å¯¹æ¯”çš„æ—¶å€™ä¸å†™key,å°†ä¼šå†æ¥ä¸€æ¬¡forå¾ªç¯,é‚£å°±æ¯”è¾ƒè´¹æ€§èƒ½äº†!!!**

## ä¸­é—´å¯¹æ¯”,èŠ‚ç‚¹éƒ½å­˜åœ¨,éœ€è¦ç§»åŠ¨èŠ‚ç‚¹


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dbe89b25f89946c6a07018fee7264576~tplv-k3u1fbpfcp-watermark.image?)
é€šè¿‡ä¸Šé¢ä»£ç çš„æ‰§è¡Œï¼Œæœ€ç»ˆ `i = 2, e1 =4ï¼Œ e2 = 4`ï¼Œ
åœ¨ä¸Šé¢çš„å›¾ä¸­,ä¼šå‘ç°æ–°è€èŠ‚ç‚¹ä¸­åªæœ‰**Eçš„èŠ‚ç‚¹ç§»åŠ¨äº†,å…¶ä»–çš„èŠ‚ç‚¹éƒ½ä¸åŠ¨**,é‚£ä¹ˆæ€ä¹ˆæ‰¾å‡º [C,D,E]å’Œ[E,C,D]ä¸­çš„æœ€é•¿è¿ç»­çš„èŠ‚ç‚¹å‘¢?

é‡åˆ°è¿™ä¸ª,è‚¯å®šéœ€è¦ä½¿ç”¨ **æœ€é•¿é€’å¢å­åºåˆ—çš„ç®—æ³•**å•¦,é€šè¿‡è¿™ä¸ªå¯ä»¥å¾—å‡ºæœ€é•¿èŠ‚ç‚¹çš„è¿ç»­èŒƒå›´.

ä½†æ˜¯æœ€é•¿é€’å¢å­åºåˆ—ä¸­éœ€è¦ä¸€ä¸ªæ•°ç»„,è¿™ä¸ªæ•°ç»„éœ€è¦è®°å½•è€èŠ‚ç‚¹ä¸æ–°èŠ‚ç‚¹çš„ä½ç½®å…³ç³»


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a0a12f4528694e4bafffc6d96a09bf7b~tplv-k3u1fbpfcp-watermark.image?)\

> é€šè¿‡ä¸Šå›¾,å¯ä»¥çœ‹åˆ°,å…ˆå®šä¹‰ä¸€ä¸ªæ•°ç»„,é•¿åº¦æ˜¯å¯¹æ¯”ä¹‹åçš„é•¿åº¦,ç„¶åé»˜è®¤**èµ‹å€¼ä¸º0**,ç„¶åéå†è€èŠ‚ç‚¹,ç”¨è€èŠ‚ç‚¹çš„iæ¥è¡¨ç¤ºæ•°ç»„çš„ç»“æœ,newIndexè¡¨ç¤ºæ•°æ®çš„ä¸‹æ ‡,è¿™æ ·å°±èƒ½å±•ç¤ºå‡ºæ–°è€èŠ‚ç‚¹çš„æ˜ å°„å…³ç³»äº†


æ¥ä¸‹æ¥å®ç°ä¸€ä¸‹è¿™éƒ¨åˆ†çš„åŠŸèƒ½,ç”±äºè¿™ä¸€éƒ¨åˆ†çš„å†…å®¹ä¸æ•´ä½“æœ‰å…³,æˆ‘æŠŠæ•´ä¸ªdiffçš„é€»è¾‘éƒ½æ”¾å‡ºæ¥,å…¨éƒ¨å·²ç»å†™å¥½æ³¨é‡Šäº†ğŸ˜‰ğŸ˜‰ğŸ˜‰


```js
 function patchKeyChildren(n1, n2, container, parentComponent, anchor) {

    // é‡‡ç”¨åŒç«¯å¯¹æ¯”æ³•
    const l2 = n2.length
    const l1 = n1.length
    let i = 0;
    let e1 = l1 - 1;
    let e2 = l2 - 1;

    const isSameVNode = (vnode1, vnode2) => {
      return vnode1.type === vnode2.type && vnode1.key === vnode2.key
    }

    // è·å–å·¦ä¾§çš„ä½ç½®
    while (i <= e1 && i <= e2) {
      if (isSameVNode(n1[i], n2[i])) {
        // å¯¹æ¯”å¯¹åº”çš„å­èŠ‚ç‚¹
        patch(n1[i], n2[i], container, parentComponent, anchor)
      } else {
        break;
      }
      i++
    }
    // è·å–å³ä¾§æ˜¯ä½ç½®
    while (i <= e1 && i <= e2) {
      if (isSameVNode(n1[e1], n2[e2])) {
        patch(n1[e1], n2[e2], container, parentComponent, anchor)
      } else {
        break;
      }
      e1--;
      e2--;
    }

    // æ–°çš„æ¯”è€çš„çŸ­ï¼Œåˆ é™¤è€çš„
    if (i >= e2 && i <= e1) {
      while (i <= e1) {
        hostRemove(n1[i].el)
        i++
      }
    }

    // æ–°çš„æ¯”è€çš„é•¿ï¼ŒæŒ‚è½½æ–°çš„
    else if (i > e1 && i <= e2) {
      // å¾€å·¦ä¾§æ·»åŠ  
      //    a b   i = 0 e1 = -1 e2 = 0
      // d c a b  éœ€è¦æ‰¾åˆ°açš„ä½ç½®
      const nextPos = e2 + 1;
      const anchor = nextPos < l2 ? n2[nextPos].el : null
      while (i <= e2) {
        patch(null, n2[i], container, parentComponent, anchor)
        i++
      }
    }
    else {
      // ä¸­é—´å¯¹æ¯”
      const s1 = i;
      const s2 = i;
      // a b c d   i = 2 e1 = 2 e2 = 1
      // a b d
      // æ¡ä»¶  åˆ é™¤c

      // åˆ¤æ–­æ—§èŠ‚ç‚¹æ˜¯å¦åœ¨æ–°èŠ‚ç‚¹é‡Œé¢ï¼Œåœ¨çš„è¯ä¿ç•™ï¼Œä¸åœ¨åˆ™åˆ é™¤
      const newIndexToOldIndexMap = new Map()
      // å¢åŠ ä¸€ä¸ªä¼˜åŒ–ç‚¹,å¦‚æœæ—§èŠ‚ç‚¹çš„æ•°é‡å’Œæ–°èŠ‚ç‚¹çš„æ•°é‡å·²ç»ä¸€è‡´ï¼Œé‚£ä¹ˆå…¶ä½™æ—§èŠ‚ç‚¹ç›´æ¥åˆ é™¤
      const toBePatched = e2 - s1 + 1;
      let patched = 0;

      // å°†è€èŠ‚ç‚¹å’Œæ–°èŠ‚ç‚¹åšæ˜ å°„ b c d --> c d b
      const oldIndexToNewIndexMap = new Array(toBePatched).fill(0)
      // åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»åŠ¨èŠ‚ç‚¹ï¼Œä¸éœ€è¦ç§»åŠ¨åˆ™ä¸éœ€è¦è°ƒç”¨è·å–æœ€é•¿é€’å¢å­åºåˆ—
      let moved = false;
      let maxIndexSoFar = 0;

      // æŠŠæ–°èŠ‚ç‚¹çš„keyè£…å…¥map
      for (let j = s2; j <= e2; j++) {
        newIndexToOldIndexMap.set(n2[j].key, j)
      }

      for (let i = s1; i <= e1; i++) {
        // æ–°èŠ‚ç‚¹å·²ç»æ»¡è¶³å‰é¢å¯¹æ¯”çš„è€èŠ‚ç‚¹ï¼Œéœ€è¦åˆ é™¤å…¶ä½™çš„è€èŠ‚ç‚¹
        if (patched >= toBePatched) {
          hostRemove(n1[i].el)
          continue;
        }
        let newIndex;
        if (n1[i].key !== null) {
          newIndex = newIndexToOldIndexMap.get(n1[i].key)
        } else {
          // key ä¸å­˜åœ¨ï¼Œéœ€è¦éå†æ–°èŠ‚ç‚¹ï¼Œçœ‹èƒ½ä¸èƒ½æ‰¾åˆ°è¿™ä¸ªèŠ‚ç‚¹
          for (let j = s2; j <= e2; j++) {
            if (isSameVNode(n1[i], n2[j])) {
              newIndex = j
              break;
            }
          }
        }
        if (newIndex === undefined) {
          // åˆ é™¤èŠ‚ç‚¹
          hostRemove(n1[i].el)
        } else {
          // æ›´æ–°æ˜ å°„å…³ç³»
          oldIndexToNewIndexMap[newIndex - s1] = i + 1
          // åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»åŠ¨èŠ‚ç‚¹
          if (newIndex > maxIndexSoFar) {
            maxIndexSoFar = newIndex;
          } else {
            moved = true
          }
          // å­˜åœ¨çš„è¯ï¼Œè¿›è¡Œä¸‹ä¸€æ¬¡çš„patch
          patch(n1[i], n2[newIndex], container, parentComponent, anchor)
          patched++
        }
      }

      // è·å–æœ€é•¿é€’å¢åºåˆ—  è·å–çš„æ˜¯æœ€é•¿é€’å¢å­åºåˆ—çš„ç´¢å¼•ä¸‹æ ‡æ•°ç»„
      const longestIncreasingSubsequence = moved ? getLongestIncreasingSubsequence(oldIndexToNewIndexMap) : []
      // éå†ï¼Œåˆ¤æ–­å½“å‰çš„ä¸‹æ ‡æ˜¯å¦å­˜åœ¨äºæœ€é•¿é€’å¢åºåˆ—ä¸­ï¼Œå­˜åœ¨åˆ™ä¸éœ€è¦ç§»åŠ¨ï¼Œä¸å­˜åœ¨éœ€è¦ç§»åŠ¨

      // ä½¿ç”¨æ¸¸æ ‡j
      let j = longestIncreasingSubsequence.length - 1;
      for (let i = toBePatched - 1; i >= 0; i--) {
        // è®¡ç®—ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
        const curIndex = i + s2;
        const anchor = curIndex + 1 < l2 ? n2[curIndex + 1].el : null;
        if (oldIndexToNewIndexMap[i] === 0) {
          // æ–°å¢èŠ‚ç‚¹
          patch(null, n2[i + s2], container, parentComponent, anchor)
        }
        else if (moved) {
          if (j < 0 || i !== longestIncreasingSubsequence[j]) {

            // ç§»åŠ¨èŠ‚ç‚¹
            hostInsert(n2[curIndex].el, container, anchor)
          } else {
            // å‘½ä¸­ç›®æ ‡èŠ‚ç‚¹ï¼Œä¸éœ€è¦ç§»åŠ¨
            j--;
          }
        }
      }
    }
  }
```

## ä¸­é—´èŠ‚ç‚¹æ–°å¢
å¯¹äºè¿™ä¸ªåŠŸèƒ½,å¦‚æœçœ‹æ‡‚äº†ä¸Šé¢ä»£ç çš„è¯,æ˜¯éå¸¸ç®€å•çš„,åªéœ€è¦åˆ¤æ–­`oldIndexToNewIndexMap[i]`æ˜¯å¦ä¸º0,ä¸º0åˆ™ä»£è¡¨,è€èŠ‚ç‚¹ä¸­æ²¡æœ‰,æ–°èŠ‚ç‚¹æœ‰,éœ€è¦æ–°å¢èŠ‚ç‚¹å“¦!

# æ€»ç»“

æœ¬æœŸä¸»è¦å®ç°äº†vue3çš„diffç®—æ³•,ä¸»è¦åˆ†ä¸º7ä¸ªéƒ¨åˆ†:
1. è€çš„æ¯”æ–°çš„**å·¦è¾¹é•¿**ï¼Œåœ¨æ–°çš„å·¦è¾¹åˆ›åˆ é™¤çš„èŠ‚ç‚¹
2. è€çš„æ¯”æ–°çš„**å³è¾¹é•¿**ï¼Œåœ¨æ–°çš„å³è¾¹åˆ›åˆ é™¤çš„èŠ‚ç‚¹
3. è€çš„æ¯”æ–°å¤§**å·¦è¾¹çŸ­**,åœ¨æ–°çš„å·¦è¾¹åˆ›å»ºæ–°çš„èŠ‚ç‚¹
4. è€çš„æ¯”æ–°çš„**å³è¾¹çŸ­**ï¼Œåœ¨æ–°çš„å³è¾¹åˆ›å»ºæ–°çš„èŠ‚ç‚¹
5. è€çš„æ¯”æ–°çš„**ä¸­é—´èŠ‚ç‚¹å¤š**,åˆ é™¤å¤šä½™çš„èŠ‚ç‚¹
6. è€çš„æ–°çš„**ä¸­é—´èŠ‚ç‚¹ä¸€æ ·å¤šï¼Œä½ç½®å‘ç”Ÿå˜åŒ–**ï¼Œéœ€è¦ç§»åŠ¨ä½ç½®
7. è€çš„æ–°çš„**ä¸­é—´èŠ‚ç‚¹å°‘**ï¼Œåˆ›å»ºæ–°çš„èŠ‚ç‚¹
åªæœ‰åœ¨ä¸­é—´èŠ‚ç‚¹ä¸€æ ·å¤šçš„æ—¶å€™,æ‰ä¼šä½¿ç”¨æœ€é•¿é€’å¢å­åºåˆ—,æ¥åˆ¤æ–­å“ªäº›æ˜¯éœ€è¦ç§»åŠ¨çš„,åªèƒ½è¯´vue3çš„è®¾è®¡å¤ªå‰å®³å’Œçµæ´»äº†,åŠ æ²¹!!!
